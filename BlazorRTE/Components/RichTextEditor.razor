@using BlazorRTE.HelperClasses
@using BlazorEmo.Components
@using BlazorEmo.Models

<div class="rich-text-editor @(IsFocused ? "focused" : "") @(DarkMode ? "dark-mode" : "")" style="@GetEditorStyle()">
    @if (ShowToolbar)
    {
        <div class="rte-toolbar"
             role="toolbar"
             aria-label="Rich text formatting"
             aria-controls="rte-editor"
             @onkeydown="HandleToolbarKeydown"
             @onkeydown:preventDefault
             @onmousedown="OnToolbarMouseDown"
             @onmousedown:preventDefault>

            @* ===== HISTORY GROUP ===== *@
            <div role="group" aria-label="History">
                <button type="button"
                        class="rte-btn"
                        aria-label="Undo"
                        tabindex="0"
                        data-toolbar-item
                        @onfocus="() => focusedIndex = 0"
                        @onclick="() => ExecuteCommand(FormatCommand.Undo)"
                        @onkeydown="@(e => HandleButtonKeyDown(e, () => ExecuteCommand(FormatCommand.Undo)))"
                        @onmousedown:preventDefault
                        data-tooltip="Undo (Ctrl+Z)">
                    <svg class="rte-icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 15 3 9m0 0 6-6M3 9h12a6 6 0 0 1 0 12h-3" />
                    </svg>
                    <span class="sr-only">Undo</span>
                </button>

                <button type="button"
                        class="rte-btn"
                        aria-label="Redo"
                        tabindex="-1"
                        data-toolbar-item
                        @onclick="() => ExecuteCommand(FormatCommand.Redo)"
                        @onkeydown="@(e => HandleButtonKeyDown(e, () => ExecuteCommand(FormatCommand.Redo)))"
                        data-tooltip="Redo (Ctrl+Y)">
                    <svg class="rte-icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m15 15 6-6m0 0-6-6m6 6H9a6 6 0 0 0 0 12h3" />
                    </svg>
                    <span class="sr-only">Redo</span>
                </button>
            </div>

            <span class="rte-separator" role="separator" aria-orientation="vertical"></span>

            @* ===== TEXT STYLE GROUP ===== *@
            <div role="group" aria-label="Text style">
                @* Heading Level Picker *@
                <div class="rte-color-dropdown">
                    <button type="button"
                            @ref="_headingButton"
                            class="rte-btn rte-btn-wide"
                            aria-label="Heading level"
                            aria-haspopup="true"
                            aria-expanded="@_showHeadingPicker.ToString().ToLower()"
                            tabindex="-1"
                            data-toolbar-item
                            @onclick="ToggleHeadingPicker"
                            @onkeydown="@(e => HandleButtonKeyDown(e, ToggleHeadingPicker))"
                            @onclick:stopPropagation
                            data-tooltip="Heading Level">
                        @GetCurrentHeadingLabel()
                    </button>

                    @if (_showHeadingPicker)
                    {
                        <div @ref="_headingPalette"
                             class="rte-color-palette"
                             role="listbox"
                             aria-label="Heading levels"
                             @onclick:stopPropagation
                             @onkeydown="@(e => HandleListPickerKeydown(e, "heading"))">
                            <div class="rte-color-palette-title">Heading Level</div>
                            <div class="rue-font-size-list">

                                @* Normal option *@
                                <button type="button" class="rte-font-option" role="option" tabindex="-1"
                                        @onclick="@(() => SelectHeading("p"))"
                                        @onkeydown="@(e => HandleColorButtonKeyDown(e, () => SelectHeading("p")))">
                                    Normal (Ctrl+Alt+0)
                                </button>

                                @* Heading 1 option *@
                                <button type="button" class="rte-font-option" role="option" tabindex="-1"
                                        @onclick="@(() => SelectHeading("h1"))"
                                        @onkeydown="@(e => HandleColorButtonKeyDown(e, () => SelectHeading("h1")))">
                                    Heading 1 (Ctrl+Alt+1)
                                </button>

                                @* Heading 2 option *@
                                <button type="button" class="rte-font-option" role="option" tabindex="-1"
                                        @onclick="@(() => SelectHeading("h2"))"
                                        @onkeydown="@(e => HandleColorButtonKeyDown(e, () => SelectHeading("h2")))">
                                    Heading 2 (Ctrl+Alt+2)
                                </button>

                                @* Heading 3 option *@
                                <button type="button" class="rte-font-option" role="option" tabindex="-1"
                                        @onclick="@(() => SelectHeading("h3"))"
                                        @onkeydown="@(e => HandleColorButtonKeyDown(e, () => SelectHeading("h3")))">
                                    Heading 3 (Ctrl+Alt+3)
                                </button>

                            </div>
                        </div>
                    }
                </div>

                @* Font Family Picker *@
                <div class="rte-color-dropdown">
                    <button type="button"
                            @ref="_fontFamilyButton"
                            class="rte-btn"
                            aria-label="Font family"
                            aria-haspopup="true"
                            aria-expanded="@_showFontFamilyPicker.ToString().ToLower()"
                            tabindex="-1"
                            data-toolbar-item
                            @onclick="ToggleFontFamilyPicker"
                            @onkeydown="@(e => HandleButtonKeyDown(e, ToggleFontFamilyPicker))"
                            @onclick:stopPropagation
                            data-tooltip="Font Family">
                        Aa
                    </button>

                    @if (_showFontFamilyPicker)
                    {
                        <div @ref="_fontFamilyPalette"
                             class="rte-color-palette rte-font-family-palette"
                             role="listbox"
                             aria-label="Font families"
                             @onclick:stopPropagation
                             @onkeydown="@(e => HandleListPickerKeydown(e, "fontFamily"))">
                            <div class="rte-color-palette-title" id="font-family-label">Font Family</div>
                            <div class="rte-font-family-list" aria-labelledby="font-family-label">
                                @foreach (var font in _fontFamilies)
                                {
                                    <button type="button"
                                            class="rte-font-option"
                                            role="option"
                                            tabindex="-1"
                                            aria-label="@font.Value"
                                            style="font-family: @font.Key;"
                                            @onclick="@(() => SelectFontFamily(font.Key))"
                                            @onkeydown="@(e => HandleColorButtonKeyDown(e, () => SelectFontFamily(font.Key)))"
                                            data-tooltip="@font.Value">
                                        @font.Value
                                    </button>
                                }
                            </div>
                        </div>
                    }
                </div>

                @* Font Size Picker *@
                <div class="rte-color-dropdown">
                    <button type="button"
                            @ref="_fontSizeButton"
                            class="rte-btn"
                            aria-label="Font size"
                            aria-haspopup="true"
                            aria-expanded="@_showFontSizePicker.ToString().ToLower()"
                            tabindex="-1"
                            data-toolbar-item
                            @onclick="ToggleFontSizePicker"
                            @onkeydown="@(e => HandleButtonKeyDown(e, ToggleFontSizePicker))"
                            @onclick:stopPropagation
                            data-tooltip="Font Size (Ctrl+Shift+> / Ctrl+Shift+<)">
                        14
                    </button>

                    @if (_showFontSizePicker)
                    {
                        <div @ref="_fontSizePalette"
                             class="rte-color-palette"
                             role="listbox"
                             aria-label="Font sizes"
                             @onkeydown="@(e => HandleListPickerKeydown(e, "fontSize"))">
                            <div class="rte-color-palette-title" id="font-size-label">Font Size</div>
                            <div class="rte-font-size-list" aria-labelledby="font-size-label">
                                @foreach (var size in _fontSizes)
                                {
                                    <button type="button"
                                            class="rte-font-option"
                                            role="option"
                                            tabindex="-1"
                                            aria-label="@size.Value"
                                            @onclick="@(() => SelectFontSize(size.Key))"
                                            @onkeydown="@(e => HandleColorButtonKeyDown(e, () => SelectFontSize(size.Key)))"
                                            data-tooltip="@size.Value">
                                        @size.Value
                                    </button>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>

            <span class="rte-separator" role="separator" aria-orientation="vertical"></span>

            @* ===== TEXT FORMAT GROUP ===== *@
            <div role="group" aria-label="Text formatting">
                <button type="button"
                        class="rte-btn @(IsFormatActive("bold") ? "active" : "")"
                        aria-pressed="@IsFormatActive("bold").ToString().ToLower()"
                        aria-label="Bold"
                        tabindex="-1"
                        data-toolbar-item
                        @onclick="ToggleBold"
                        @onkeydown="@(e => HandleButtonKeyDown(e, ToggleBold))"
                        data-tooltip="Bold (Ctrl+B)">
                    <svg class="rte-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8.916 18.25q-.441 0-.74-.299t-.299-.74V6.79q0-.441.299-.74t.74-.299h3.159q1.433 0 2.529.904T15.7 9.006q0 .967-.508 1.693t-1.257 1.065q.913.255 1.55 1.073t.638 1.97q0 1.61-1.202 2.527q-1.202.916-2.646.916zm.236-1.184h3.062q1.161 0 1.875-.7q.715-.699.715-1.627q0-.93-.714-1.629q-.715-.698-1.894-.698H9.152zm0-5.816h2.864q.997 0 1.69-.617t.692-1.546q0-.947-.704-1.553q-.704-.605-1.667-.605H9.152z" />
                    </svg>
                    <span class="sr-only">Bold</span>
                </button>

                <button type="button"
                        class="rte-btn @(IsFormatActive("italic") ? "active" : "")"
                        aria-pressed="@IsFormatActive("italic").ToString().ToLower()"
                        aria-label="Italic"
                        tabindex="-1"
                        data-toolbar-item
                        @onclick="() => ExecuteCommand(FormatCommand.Italic)"
                        @onkeydown="@(e => HandleButtonKeyDown(e, () => ExecuteCommand(FormatCommand.Italic)))"
                        data-tooltip="Italic (Ctrl+I)">
                    <svg class="rte-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M6.346 18.25q-.234 0-.396-.162t-.161-.397t.161-.396t.396-.16h3.077l3.48-10.27H9.828q-.234 0-.396-.162t-.162-.397t.162-.395t.396-.161h7.192q.235 0 .396.162t.162.397t-.162.396q-.161.16-.396.16h-2.961l-3.481 10.27h2.962q.234 0 .395.162t.162.397t-.162.396t-.395.16z" />
                    </svg>
                    <span class="sr-only">Italic</span>
                </button>

                <button type="button"
                        class="rte-btn @(IsFormatActive("underline") ? "active" : "")"
                        aria-pressed="@IsFormatActive("underline").ToString().ToLower()"
                        aria-label="Underline"
                        tabindex="-1"
                        data-toolbar-item
                        @onclick="() => ExecuteCommand(FormatCommand.Underline)"
                        @onkeydown="@(e => HandleButtonKeyDown(e, () => ExecuteCommand(FormatCommand.Underline)))"
                        data-tooltip="Underline (Ctrl+U)">
                    <svg class="rte-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M6.192 19.25q-.212 0-.356-.144t-.144-.357t.144-.356t.356-.143h11.616q.212 0 .356.144t.144.357t-.144.356t-.356.143zM12 16.058q-2.14 0-3.358-1.258t-1.217-3.415V4.39q0-.233.171-.398q.171-.166.403-.166t.395.166t.164.398v7.028q0 1.631.911 2.583q.912.952 2.531.952t2.53-.952t.912-2.583V4.391q0-.233.172-.398q.17-.166.402-.166t.396.166t.163.398v6.994q0 2.157-1.217 3.415T12 16.058" />
                    </svg>
                    <span class="sr-only">Underline</span>
                </button>

                <button type="button"
                        class="rte-btn @(IsFormatActive("strikeThrough") ? "active" : "")"
                        aria-pressed="@IsFormatActive("strikeThrough").ToString().ToLower()"
                        aria-label="Strikethrough"
                        tabindex="-1"
                        data-toolbar-item
                        @onclick="() => ExecuteCommand(FormatCommand.Strikethrough)"
                        @onkeydown="@(e => HandleButtonKeyDown(e, () => ExecuteCommand(FormatCommand.Strikethrough)))"
                        data-tooltip="Strikethrough (Ctrl+Shift+X)">
                    <svg class="rte-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M3.5 13.48q-.213 0-.356-.143Q3 13.193 3 12.98t.144-.356t.356-.143h17q.213 0 .356.144t.144.357t-.144.356t-.356.143zm7.885-2.96V6.25h-4.75q-.257 0-.436-.18q-.18-.18-.18-.438q0-.257.18-.444T6.635 5h10.75q.256 0 .436.18q.179.18.179.438q0 .257-.18.444t-.435.188h-4.75v4.27zm0 4.922h1.25v2.942q0 .257-.18.436q-.18.18-.438.18q-.257 0-.445-.185q-.187-.185-.187-.45z" />
                    </svg>
                    <span class="sr-only">Strikethrough</span>
                </button>

                <button type="button"
                        class="rte-btn @(IsFormatActive("subscript") ? "active" : "")"
                        aria-pressed="@IsFormatActive("subscript").ToString().ToLower()"
                        aria-label="Subscript"
                        tabindex="-1"
                        data-toolbar-item
                        @onclick="() => ExecuteCommand(FormatCommand.Subscript)"
                        @onkeydown="@(e => HandleButtonKeyDown(e, () => ExecuteCommand(FormatCommand.Subscript)))"
                        data-tooltip="Subscript (Ctrl+=)">
                    <svg class="rte-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19.192 19q-.343 0-.575-.232t-.233-.576v-.769q0-.343.233-.575q.232-.233.575-.233H21v-.846h-2.23q-.155 0-.27-.115t-.115-.27q0-.153.115-.268q.116-.116.27-.116h2.192q.343 0 .575.232t.232.576v.769q0 .343-.232.576t-.575.232h-1.808v.846h2.23q.155 0 .27.115q.115.116.115.27q0 .153-.115.269q-.115.115-.27.115zM8.008 17.384q-.328 0-.48-.276q-.153-.277.024-.564l3.64-5.627l-3.296-5.083q-.177-.28-.024-.557Q8.024 5 8.34 5q.146 0 .263.067q.116.067.187.189l3.178 4.936h.023l3.231-4.955q.069-.113.19-.175q.12-.062.255-.062q.332 0 .479.277t-.03.564l-3.354 5.076l3.685 5.627q.177.287.02.564q-.156.277-.47.277q-.142 0-.26-.067t-.19-.19l-3.556-5.457h-.023L8.452 17.13q-.069.122-.19.189q-.12.067-.254.067" />
                    </svg>
                    <span class="sr-only">Subscript</span>
                </button>

                <button type="button"
                        class="rte-btn @(IsFormatActive("superscript") ? "active" : "")"
                        aria-pressed="@IsFormatActive("superscript").ToString().ToLower()"
                        aria-label="Superscript"
                        tabindex="-1"
                        data-toolbar-item
                        @onclick="() => ExecuteCommand(FormatCommand.Superscript)"
                        @onkeydown="@(e => HandleButtonKeyDown(e, () => ExecuteCommand(FormatCommand.Superscript)))"
                        data-tooltip="Superscript (Ctrl+Shift+=)">
                    <svg class="rte-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19.192 9q-.343 0-.575-.232t-.233-.576v-.769q0-.343.233-.575q.232-.232.575-.232H21v-.847h-2.23q-.155 0-.27-.115t-.115-.27q0-.153.115-.268q.116-.116.27-.116h2.192q.343 0 .575.232t.232.576v.769q0 .343-.232.576t-.575.232h-1.808v.846h2.23q.155 0 .27.115q.115.116.115.27q0 .153-.115.269q-.115.115-.27.115zM8.008 19q-.328 0-.48-.277q-.153-.277.024-.563l3.64-5.627L7.896 7.45q-.177-.28-.024-.558q.152-.276.469-.276q.146 0 .263.066q.116.067.187.19l3.178 4.936h.023l3.231-4.956q.069-.113.19-.175q.12-.061.255-.061q.332 0 .479.276q.147.277-.03.564l-3.354 5.077l3.685 5.627q.177.286.02.563q-.156.277-.47.277q-.142 0-.26-.067t-.19-.189l-3.556-5.457h-.023l-3.517 5.457q-.069.122-.19.189q-.12.067-.254.067" />
                    </svg>
                    <span class="sr-only">Superscript</span>
                </button>
            </div>

            <span class="rte-separator" role="separator" aria-orientation="vertical"></span>

            @* ===== COLOR GROUP ===== *@
            <div role="group" aria-label="Text colors">
                <div class="rte-color-dropdown">
                    <button type="button"
                            @ref="_textColorButton"
                            class="rte-btn @(IsFormatActive("foreColor") ? "active" : "")"
                            aria-label="Text color"
                            aria-haspopup="true"
                            aria-expanded="@_showTextColorPicker.ToString().ToLower()"
                            tabindex="-1"
                            data-toolbar-item
                            @onclick="ToggleTextColorPicker"
                            @onkeydown="@(e => HandleButtonKeyDown(e, ToggleTextColorPicker))"
                            @onclick:stopPropagation
                            data-tooltip="Text Color">
                        <svg class="rte-icon" width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                            <!-- Letter "A" - uses currentColor for dark mode support -->
                            <path fill="currentColor" d="M7.01 16.4q-.287 0-.442-.228q-.154-.228-.05-.49l4.9-11.994q.048-.119.155-.204q.108-.084.246-.084h.362q.144 0 .249.084q.105.085.153.204l4.886 11.943q.104.28-.06.525q-.165.244-.451.244q-.177 0-.323-.094t-.214-.271l-1.302-3.273H8.816L7.502 16.06q-.067.157-.191.249q-.125.091-.302.091m2.16-4.6h5.585L12.05 5.0h-.138z" />
                            <!-- Dynamic color underline -->
                            <rect x="3.8" y="19" width="16.4" height="2.5" rx="0.5" fill="@_currentTextColor" />
                        </svg>
                        <span class="sr-only">Text Color</span>
                    </button>

                    @if (_showTextColorPicker)
                    {
                        <div @ref="_textColorPalette"
                             class="rte-color-palette"
                             role="grid"
                             aria-label="Text colors"
                             @onclick:stopPropagation>
                            <div class="rte-color-palette-title" id="text-color-label">Text Color</div>
                            <div class="rte-color-palette-grid" aria-labelledby="text-color-label">
                                @foreach (var color in ColorPalette.TextColors)
                                {
                                    <button type="button"
                                            class="rte-palette-color"
                                            role="gridcell"
                                            tabindex="-1"
                                            aria-label="@color.Value"
                                            style="background-color: @color.Key;"
                                            @onclick="@(() => SelectTextColor(color.Key))"
                                            @onkeydown="@(e => HandleColorButtonKeyDown(e, () => SelectTextColor(color.Key)))"
                                            data-tooltip="@color.Value"></button>
                                }
                            </div>
                        </div>
                    }
                </div>

                <div class="rte-color-dropdown">
                    <button type="button"
                            @ref="_bgColorButton"
                            class="rte-btn @(IsFormatActive("backColor") ? "active" : "")"
                            aria-label="Highlight color"
                            aria-haspopup="true"
                            aria-expanded="@_showBackgroundColorPicker.ToString().ToLower()"
                            tabindex="-1"
                            data-toolbar-item
                            @onclick="ToggleBackgroundColorPicker"
                            @onkeydown="@(e => HandleButtonKeyDown(e, ToggleBackgroundColorPicker))"
                            @onclick:stopPropagation
                            data-tooltip="Highlight Color">
                        <span class="rte-highlight-indicator" style="background-color: @_currentHighlightColor;">A</span>
                    </button>

                    @if (_showBackgroundColorPicker)
                    {
                        <div @ref="_bgColorPalette"
                             class="rte-color-palette"
                             role="grid"
                             aria-label="Highlight colors"
                             @onclick:stopPropagation>
                            <div class="rte-color-palette-title" id="bg-color-label">Highlight Color</div>
                            <div class="rte-color-palette-grid" aria-labelledby="bg-color-label">
                                @foreach (var color in ColorPalette.BackgroundColors)
                                {
                                    @if (color.Key == "transparent")
                                    {
                                        <button type="button"
                                                class="rte-palette-color rte-palette-color-none"
                                                role="gridcell"
                                                tabindex="-1"
                                                aria-label="@color.Value"
                                                @onclick="@(() => SelectBackgroundColor(color.Key))"
                                                @onkeydown="@(e => HandleColorButtonKeyDown(e, () => SelectBackgroundColor(color.Key)))"
                                                data-tooltip="@color.Value">
                                            <span aria-hidden="true">âœ•</span>
                                        </button>
                                    }
                                    else
                                    {
                                        <button type="button"
                                                class="rte-palette-color"
                                                role="gridcell"
                                                tabindex="-1"
                                                aria-label="@color.Value"
                                                style="background-color: @color.Key;"
                                                @onclick="@(() => SelectBackgroundColor(color.Key))"
                                                @onkeydown="@(e => HandleColorButtonKeyDown(e, () => SelectBackgroundColor(color.Key)))"
                                                data-tooltip="@color.Value"></button>
                                    }
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>

            <span class="rte-separator" role="separator" aria-orientation="vertical"></span>

            @* ===== PARAGRAPH GROUP ===== *@
            <div role="group" aria-label="Paragraph formatting">
                <button type="button"
                        class="rte-btn @(IsFormatActive("insertUnorderedList") ? "active" : "")"
                        aria-pressed="@IsFormatActive("insertUnorderedList").ToString().ToLower()"
                        aria-label="Bulleted list"
                        tabindex="-1"
                        data-toolbar-item
                        @onclick="() => ExecuteCommand(FormatCommand.InsertUnorderedList)"
                        @onkeydown="@(e => HandleButtonKeyDown(e, () => ExecuteCommand(FormatCommand.InsertUnorderedList)))"
                        data-tooltip="Bullet List (Ctrl+Shift+8)">
                    <svg class="rte-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0ZM3.75 12h.007v.008H3.75V12Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm-.375 5.25h.007v.008H3.75v-.008Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
                    </svg>
                    <span class="sr-only">Bulleted List</span>
                </button>

                <button type="button"
                        class="rte-btn @(IsFormatActive("insertOrderedList") ? "active" : "")"
                        aria-pressed="@IsFormatActive("insertOrderedList").ToString().ToLower()"
                        aria-label="Numbered list"
                        tabindex="-1"
                        data-toolbar-item
                        @onclick="() => ExecuteCommand(FormatCommand.InsertOrderedList)"
                        @onkeydown="@(e => HandleButtonKeyDown(e, () => ExecuteCommand(FormatCommand.InsertOrderedList)))"
                        data-tooltip="Numbered List (Ctrl+Shift+7)">
                    <svg class="rte-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M4.442 21q-.191 0-.317-.125Q4 20.75 4 20.559t.125-.318t.317-.126H6.5V18.75H5.442q-.191 0-.317-.125Q5 18.5 5 18.309t.125-.318t.317-.126H6.5V16.5H4.442q-.191 0-.317-.125Q4 16.25 4 16.059t.125-.318t.317-.126h2.25q.294 0 .493.2t.2.493v1.384q0 .294-.2.493t-.493.2q.294 0 .493.199q.2.199.2.493v1.23q0 .295-.2.494T6.692 21zm.174-6.308q-.249 0-.432-.183Q4 14.325 4 14.077V12.25q0-.294.199-.493t.493-.2H6.5v-1.365H4.442q-.191 0-.317-.125Q4 9.942 4 9.751t.125-.317t.317-.126h2.25q.294 0 .493.199t.2.493v1.75q0 .294-.2.493t-.493.2H4.884v1.365h2.058q.192 0 .317.125t.125.316t-.125.317t-.317.126zm1.327-6.308q-.191 0-.317-.125T5.5 7.942V3.885H4.442q-.191 0-.317-.125Q4 3.635 4 3.443t.125-.317T4.442 3h1.346q.248 0 .422.174t.174.422v4.346q0 .192-.125.317t-.316.125M10.116 18.5q-.213 0-.357-.144t-.143-.357t.143-.356t.357-.143H19.5q.213 0 .356.144t.144.357t-.144.356t-.356.143zm0-6q-.213 0-.357-.144t-.143-.357t.143-.356t.357-.143H19.5q.213 0 .356.144t.144.357t-.144.356t-.356.143zm0-6q-.213 0-.357-.144t-.143-.357t.143-.356t.357-.143H19.5q.213 0 .356.144t.144.357t-.144.356t-.356.143z" />
                    </svg>
                    <span class="sr-only">Numbered List</span>
                </button>

                <button type="button"
                        class="rte-btn"
                        aria-label="Decrease indent"
                        tabindex="-1"
                        data-toolbar-item
                        @onclick="() => ExecuteCommand(FormatCommand.Outdent)"
                        @onkeydown="@(e => HandleButtonKeyDown(e, () => ExecuteCommand(FormatCommand.Outdent)))"
                        data-tooltip="Decrease Indent (Ctrl+[)">
                    <svg class="rte-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M4.5 20q-.213 0-.356-.144T4 19.499t.144-.356T4.5 19h15q.213 0 .356.144t.144.357t-.144.356T19.5 20zm8-3.75q-.213 0-.356-.144T12 15.749t.144-.356t.356-.143h7q.213 0 .356.144t.144.357t-.144.356t-.356.143zm0-3.75q-.213 0-.356-.144T12 11.999t.144-.356t.356-.143h7q.213 0 .356.144t.144.357t-.144.356t-.356.143zm0-3.75q-.213 0-.356-.144T12 8.249t.144-.356t.356-.143h7q.213 0 .356.144t.144.357t-.144.356t-.356.143zM4.5 5q-.213 0-.356-.144T4 4.499t.144-.356T4.5 4h15q.213 0 .356.144t.144.357t-.144.356T19.5 5zm.196 9.112l-1.82-1.82q-.13-.124-.13-.289t.13-.295l1.82-1.82q.192-.192.444-.095t.252.369v3.677q0 .271-.252.368t-.445-.095" />
                    </svg>

                    <span class="sr-only">Decrease Indent</span>
                </button>

                <button type="button"
                        class="rte-btn"
                        aria-label="Increase indent"
                        tabindex="-1"
                        data-toolbar-item
                        @onclick="() => ExecuteCommand(FormatCommand.Indent)"
                        @onkeydown="@(e => HandleButtonKeyDown(e, () => ExecuteCommand(FormatCommand.Indent)))"
                        data-tooltip="Increase Indent (Ctrl+]" )>
                    <svg class="rte-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M4.5 20q-.213 0-.356-.144T4 19.499t.144-.356T4.5 19h15q.213 0 .356.144t.144.357t-.144.356T19.5 20zm8-3.75q-.213 0-.356-.144T12 15.749t.144-.356t.356-.143h7q.213 0 .356.144t.144.357t-.144.356t-.356.143zm0-3.75q-.213 0-.356-.144T12 11.999t.144-.356t.356-.143h7q.213 0 .356.144t.144.357t-.144.356t-.356.143zm0-3.75q-.213 0-.356-.144T12 8.249t.144-.356t.356-.143h7q.213 0 .356.144t.144.357t-.144.356t-.356.143zM4.5 5q-.213 0-.356-.144T4 4.499t.144-.356T4.5 4h15q.213 0 .356.144t.144.357t-.144.356T19.5 5zm.196 9.112q-.192.192-.444.095T4 13.838v-3.676q0-.272.252-.369t.444.096l1.82 1.819q.13.123.13.288t-.13.296z" />
                    </svg>
                    <span class="sr-only">Increase Indent</span>
                </button>
            </div>

            <span class="rte-separator" role="separator" aria-orientation="vertical"></span>

            @* ===== ALIGNMENT GROUP ===== *@
            <div role="group" aria-label="Text alignment">
                <button type="button"
                        class="rte-btn @(alignment == "left" ? "active" : "")"
                        aria-pressed="@(alignment == "left").ToString().ToLower()"
                        aria-label="Align left"
                        tabindex="-1"
                        data-toolbar-item
                        @onclick="() => ExecuteCommand(FormatCommand.AlignLeft)"
                        @onkeydown="@(e => HandleButtonKeyDown(e, () => ExecuteCommand(FormatCommand.AlignLeft)))"
                        data-tooltip="Align Left (Ctrl+L)">
                    <svg class="rte-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M4.5 20q-.213 0-.356-.144T4 19.499t.144-.356T4.5 19h15q.213 0 .356.144t.144.357t-.144.356T19.5 20zm0-3.75q-.213 0-.356-.144T4 15.749t.144-.356t.356-.143h9q.213 0 .356.144t.144.357t-.144.356t-.356.143zm0-3.75q-.213 0-.356-.144T4 11.999t.144-.356t.356-.143h15q.213 0 .356.144t.144.357t-.144.356t-.356.143zm0-3.75q-.213 0-.356-.144T4 8.249t.144-.356t.356-.143h9q.213 0 .356.144t.144.357t-.144.356t-.356.143zM4.5 5q-.213 0-.356-.144T4 4.499t.144-.356T4.5 4h15q.213 0 .356.144t.144.357t-.144.356T19.5 5z" />
                    </svg>
                    <span class="sr-only">Align Left</span>
                </button>

                <button type="button"
                        class="rte-btn @(alignment == "center" ? "active" : "")"
                        aria-pressed="@(alignment == "center").ToString().ToLower()"
                        aria-label="Align center"
                        tabindex="-1"
                        data-toolbar-item
                        @onclick="() => ExecuteCommand(FormatCommand.AlignCenter)"
                        @onkeydown="@(e => HandleButtonKeyDown(e, () => ExecuteCommand(FormatCommand.AlignCenter)))"
                        data-tooltip="Align Center (Ctrl+E)">
                    <svg class="rte-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M4.5 20q-.213 0-.356-.144T4 19.499t.144-.356T4.5 19h15q.213 0 .356.144t.144.357t-.144.356T19.5 20zm4-3.75q-.213 0-.356-.144T8 15.749t.144-.356t.356-.143h7q.213 0 .356.144t.144.357t-.144.356t-.356.143zm-4-3.75q-.213 0-.356-.144T4 11.999t.144-.356t.356-.143h15q.213 0 .356.144t.144.357t-.144.356t-.356.143zm4-3.75q-.213 0-.356-.144T8 8.249t.144-.356t.356-.143h7q.213 0 .356.144t.144.357t-.144.356t-.356.143zM4.5 5q-.213 0-.356-.144T4 4.499t.144-.356T4.5 4h15q.213 0 .356.144t.144.357t-.144.356T19.5 5z" />
                    </svg>
                    <span class="sr-only">Align Center</span>
                </button>

                <button type="button"
                        class="rte-btn @(alignment == "right" ? "active" : "")"
                        aria-pressed="@(alignment == "right").ToString().ToLower()"
                        aria-label="Align right"
                        tabindex="-1"
                        data-toolbar-item
                        @onclick="() => ExecuteCommand(FormatCommand.AlignRight)"
                        @onkeydown="@(e => HandleButtonKeyDown(e, () => ExecuteCommand(FormatCommand.AlignRight)))"
                        data-tooltip="Align Right (Ctrl+R)">
                    <svg class="rte-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M4.5 5q-.213 0-.356-.144T4 4.499t.144-.356T4.5 4h15q.213 0 .356.144t.144.357t-.144.356T19.5 5zm6 3.75q-.213 0-.356-.144T10 8.249t.144-.356t.356-.143h9q.213 0 .356.144t.144.357t-.144.356t-.356.143zm-6 3.75q-.213 0-.356-.144T4 11.999t.144-.356t.356-.143h15q.213 0 .356.144t.144.357t-.144.356t-.356.143zm6 3.75q-.213 0-.356-.144T10 15.749t.144-.356t.356-.143h9q.213 0 .356.144t.144.357t-.144.356t-.356.143zM4.5 20q-.213 0-.356-.144T4 19.499t.144-.356T4.5 19h15q.213 0 .356.144t.144.357t-.144.356T19.5 20z" />
                    </svg>

                    <span class="sr-only">Align Right</span>
                </button>

                <button type="button"
                        class="rte-btn @(alignment == "justify" ? "active" : "")"
                        aria-pressed="@(alignment == "justify").ToString().ToLower()"
                        aria-label="Justify"
                        tabindex="-1"
                        data-toolbar-item
                        @onclick="() => ExecuteCommand(FormatCommand.AlignJustify)"
                        @onkeydown="@(e => HandleButtonKeyDown(e, () => ExecuteCommand(FormatCommand.AlignJustify)))"
                        data-tooltip="Justify (Ctrl+J)">
                    <svg class="rte-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M4.5 20q-.213 0-.356-.144T4 19.499t.144-.356T4.5 19h15q.213 0 .356.144t.144.357t-.144.356T19.5 20zm0-3.75q-.213 0-.356-.144T4 15.749t.144-.356t.356-.143h15q.213 0 .356.144t.144.357t-.144.356t-.356.143zm0-3.75q-.213 0-.356-.144T4 11.999t.144-.356t.356-.143h15q.213 0 .356.144t.144.357t-.144.356t-.356.143zm0-3.75q-.213 0-.356-.144T4 8.249t.144-.356t.356-.143h15q.213 0 .356.144t.144.357t-.144.356t-.356.143zM4.5 5q-.213 0-.356-.144T4 4.499t.144-.356T4.5 4h15q.213 0 .356.144t.144.357t-.144.356T19.5 5z" />
                    </svg>
                    <span class="sr-only">Justify</span>
                </button>
            </div>

            <span class="rte-separator" role="separator" aria-orientation="vertical"></span>

            @* ===== INSERT GROUP ===== *@
            <div role="group" aria-label="Insert">
                <button type="button"
                        class="rte-btn @(IsFormatActive("link") ? "active" : "")"
                        aria-pressed="@IsFormatActive("link").ToString().ToLower()"
                        aria-label="Insert link"
                        tabindex="-1"
                        data-toolbar-item
                        @onclick="CreateLink"
                        @onkeydown="@(e => HandleButtonKeyDown(e, CreateLink))"
                        data-tooltip="Insert Link (Ctrl+K)">
                    <svg class="rte-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                    <span class="sr-only">Insert Link</span>
                </button>

                <button type="button"
                        class="rte-btn"
                        aria-label="Insert horizontal rule"
                        tabindex="-1"
                        data-toolbar-item
                        @onclick="() => ExecuteCommand(FormatCommand.HorizontalRule)"
                        @onkeydown="@(e => HandleButtonKeyDown(e, () => ExecuteCommand(FormatCommand.HorizontalRule)))"
                        data-tooltip="Horizontal Rule (Ctrl+Enter)">
                    <svg class="rte-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14" />
                    </svg>
                    <span class="sr-only">Horizontal Rule</span>
                </button>

                @* ===== EMOJI BUTTON (NO DROPDOWN WRAPPER) ===== *@
                <button type="button"
                        @ref="_emojiButton"
                        class="rte-btn @(_isEmojiSelected ? "active" : "")"
                        aria-label="Insert emoji"
                        aria-haspopup="true"
                        aria-expanded="@_showEmojiPicker.ToString().ToLower()"
                        aria-pressed="@_isEmojiSelected.ToString().ToLower()"
                        tabindex="-1"
                        data-toolbar-item
                        @onclick="ToggleEmojiPicker"
                        @onkeydown="@(e => HandleButtonKeyDown(e, ToggleEmojiPicker))"
                        @onclick:stopPropagation
                        data-tooltip="Insert Emoji (Ctrl+Shift+E)">
                    <span aria-hidden="true" style="font-size: 16px; line-height: 1;">ðŸ˜€</span>
                    <span class="sr-only">Insert Emoji</span>
                </button>
            </div>

            <span class="rte-separator" role="separator" aria-orientation="vertical"></span>

            @* ===== CLEAR FORMATTING (always last) ===== *@
            <button type="button"
                    class="rte-btn"
                    aria-label="Clear formatting"
                    tabindex="-1"
                    data-toolbar-item
                    @onclick="() => ExecuteCommand(FormatCommand.RemoveFormat)"
                    @onkeydown="@(e => HandleButtonKeyDown(e, () => ExecuteCommand(FormatCommand.RemoveFormat)))"
                    data-tooltip="Clear Formatting (Ctrl+\)">
                <svg class="rte-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="m12.546 9.966l-.94-.941l.788-1.904H9.78q-.21-.075-.355-.24t-.22-.335q-.11-.205.018-.433t.419-.228H18.5q.26 0 .438.178t.178.437t-.178.438t-.438.178h-4.742zM18.985 20.4l-7.62-7.638l-2.138 5.044q-.079.175-.226.28t-.347.106q-.338 0-.52-.28q-.18-.281-.047-.589l2.344-5.496l-7.023-7.004q-.14-.14-.15-.344t.15-.364t.354-.16t.354.16l15.576 15.577q.14.14.15.345t-.15.363t-.353.16t-.354-.16" />
                </svg>
                <span class="sr-only">Clear Formatting</span>
            </button>
        </div>
    }

    <div class="rte-content-wrapper">
        <div class="rte-content"
             @ref="_editorRef"
             contenteditable="true"
             tabindex="0"
             @oninput="OnInput"
             @onkeydown="OnKeyDown"
             @onpaste="OnPaste"
             @onfocus="OnFocus"
             @onblur="OnBlur"
             @onclick="OnEditorClick"
             @onmousedown="OnToolbarMouseDown"
             placeholder="@Placeholder"
             aria-label="@AriaLabel">
        </div>
    </div>

    @if (ShowCharacterCount)
    {
        <div class="rte-footer">
            <span id="rte-char-count" class="rte-char-count" aria-live="polite" aria-atomic="true">
                @GetCharacterCount() / @MaxLength characters
                @if (GetWordCount() > 0)
                {
                    <span class="rte-word-count">(@GetWordCount() words)</span>
                }
            </span>
        </div>
    }
</div>

@* EMOJI PICKER - OUTSIDE EDITOR CONTAINER FOR PROPER POSITIONING *@
@if (_showEmojiPicker)
{
    <div class="emoji-picker-portal" @onclick:stopPropagation>
        <EmoPicker IsOpen="@_showEmojiPicker"
                   OnEmojiSelected="InsertEmoji"
                   OnClose="CloseEmojiPicker"
                   UseVirtualization="true"
                   UseCompleteDataset="true" />
    </div>
}

<!-- Autocomplete OUTSIDE the editor container -->
<EmojiAutocomplete @ref="emojiAutocomplete"
                   OnEmojiSelected="OnEmojiSelected" />